LOC    OBJ              LINE   SOURCE
                        1      ; This part is nested within Rom bank D, responsibility is to adding the health upgrade to the characters.
------
                        2      ; check the game mode and branch to the routines in free space accordingly.
036FFA FA04C0           3      ; LD A, ($C004)
                        4      ; 0x03 is the Xtreme Mode value.
036FFD FE03             5      ; CP #03
036FFF C2F17D           6      ; JP NZ, $7DF1 
037002 C30C7E           7      ; JP $7E0C
                        8      ; Padding where original code was 
037005 00               9      ; NOP
037006 00               10     ; NOP
037007 00               11     ; NOP
037008 00               12     ; NOP
037009 00               13     ; NOP
03700A 00               14     ; NOP
03700B 00               15     ; NOP
03700C 00               16     ; NOP
03700D 00               17     ; NOP
03700E 00               18     ; NOP
03700F 00               19     ; NOP
037010 00               20     ; NOP
037011 00               21     ; NOP
------
                        22     ; This is 0x7DF1 at runtime, this routine is a copy of the original code and returns to original code.
037DF1 FAC9C0           23     ; LD A, ($C0C9)
037DF4 A7               24     ; AND A
037DF5 200A             25     ; JR NZ +#A
037DF7 FAD9C0           26     ; LD, ($C0D9)
037DFA C602             27     ; ADD A, 0x02
037DFC EAD9C0           28     ; LD ($C0D9), A
037DFF 1808             29     ; JR +#8
037E01 FADEC0           30     ; LD A, ($C0DE)
037E04 C602             31     ; ADD A, 0x02
037E06 EADEC0           32     ; LD ($C0DE), A
037E09 C31270           33     ; JP $7012
------
                        34     ; This is 0x7E0C at runtime, the second routine, for Xtreme Mode.
                        35     ; Override the maximum health of both characters (0xC0D9, 0xC0DE for X and Zero respectively)
037E0C FA84C0           36     ; LD A, ($C084)
037E0F EAD9C0           37     ; LD ($C0D9), A
037E12 EADEC0           38     ; LD ($C0DE), A
                        39     ; Check which character is active
037E15 FAC9C0           40     ; LD A, ($C0C9)
037E18 A7               41     ; AND A
037E19 2008             42     ; JR NZ, +#8
                        43     ; First case: set the shadow value of X's health to the current health.
037E1B FA84C0           44     ; LD A, ($C084)
037E1E EAFEDF           45     ; LD ($DFFE), A
037E21 1806             46     ; JR, +#6 go to after Zero
                        47     ; Second case: call extra block to fix Zero's maximum health, if he picked the upgrade up.
                        48     ; This is 0x7DF1 at runtime; load Zero's current health and store it in the shadow value for Zero
037E23 FA84C0           49     ; LD A, ($C084)
037E26 EAFFDF           50     ; LD ($DFFF), A
037E29 C31270           51     ; JP $7012
------
------
                        23     ; This part is in the Rom bank 2F, which overall handles the saving and loading of the SRAM.
------
                        24     ; Instead of loading the SRAM max health to the original offset for X (0xC0D9), load it to shadow value 0xDFFE
0BE59A EAFEDF           25     ; LD ($DFFE), A
------
                        26     ; Instead of loading the SRAM max health to the original offset for Zero (0xC0DE), load it to shadow value 0xDFFF
0BE5B2 EAFFDF           27     ; LD ($DFFF), A
------
                        28     ; Takes the place of another subroutine, see the code at 0x0BFF38 (line 40)
0BE618 CD387F           29     ; CALL $7F38
------
                        30     ; This block affects the saving code
                        31     ; The subroutine ensures the registers contain the right values of health, see the code at 0x0B()
0BE7F9 CD6C7F           32     ; CALL $7F6C
0BE7FD FAFEDF           33     ; LD A, $DFFE
                        34     ; a small section of original code that shouldnt be overwritten and thus isnt in this patch file.
                        35     ; After resuming most code normally, filler is used and then the real (compatible) max health value is stored via register B.
0BE811 00               36     ; NOP
0BE812 00               37     ; NOP
0BE813 78               38     ; LD A, B
0BE814 FAFFDF           39     ; LD ($DFFF), A
------
                        40     ; This block is a new subroutine that fixes the load routine to reflect the shared health upgrades.
                        41     ; Firstly add the upgrade values together to get the full highest shared health value.
0BFF38 FAFFDF           42     ; LD A, $DFFF
0BFF3B 0E10             43     ; LD C, 10
0BFF3D 91               44     ; SUB C
0BFF3E 47               45     ; LD B, A
0BFF3F FAFEDF           46     ; LD A, $DFFE
0BFF42 91               47     ; SUB C
0BFF43 80               48     ; ADD A, B
0BFF44 81               49     ; ADD A, C
                        50     ; Insert this highest shared health value into the Max health offsets of both characters.
0BFF45 EAD9C0           51     ; LD $C0D9, A
0BFF48 EADEC0           52     ; LD $C0DE, A
                        53     ; Then perform some tricks if for autosaves the current health exceeds the max health.
0BFF4B 4F               54     ; LD C, A
0BFF4C 0621             55     ; LD B, 21
0BFF4E FAD5C0           56     ; LD A, $C0D5
0BFF51 B8               57     ; CP B
0BFF52 3007             58     ; JR NC +#7
0BFF54 B9               59     ; CP C
0BFF55 3004             60     ; JR NC +#4
0BFF57 79               61     ; LD A, C
0BFF58 EAD5C0           62     ; LD $C0D5, A
0BFF5B FADAC0           63     ; LD A, $C0DA
0BFF5E B8               64     ; CP B
0BFF5F 3007             65     ; JR NC +#7
0BFF61 B9               66     ; CP C
0BFF62 3004             67     ; JR NC +#4
0BFF64 79               68     ; LD A, C
0BFF65 EADAC0           69     ; LD $C0DA, A
                        70     ; Going back on the original call
0BFF68 CDA369           71     ; CALL $69A3
0BFF6B C9               72     ; RET
------
                        73     ; This block fixes the saving code.
                        74     ; First we check if the shadow value for Zero is set, set them to 0x10, the starting health.
0BFF6C FAFFDF           75     ; LD A, ($DFFF)
0BFF6F FE00             76     ; CP 0x00
0BFF71 2005             77     ; JR NZ +#5
0BFF73 3E10             78     ; LD A, 0x10
0BFF75 EAFFDF           79     ; LD ($DFFF), A
                        80     ; Then we are going to look at whether the max value for Zero is less or equal, or more than 0x21 (0x20 being the highest full health value)
0BFF78 0E21             81     ; LD C, 0x21
0BFF7A FADAC0           82     ; LD A, ($C0DA)
0BFF7D B9               83     ; CP C
0BFF7E 47               84     ; LD B, A
0BFF7F FAFFDF           85     ; LD A, ($DFFF)
0BFF82 3006             86     ; JR NC +#6
0BFF84 B8               87     ; CP B
0BFF85 3013             88     ; JR NC +#19
0BFF87 47               89     ; LD B, A
0BFF88 1810             90     ; JR +#16
0BFF8A 4F               91     ; LD C, A
0BFF8B FADEC0           92     ; LD A, ($C0DE)
0BFF8E 91               93     ; SUB C
0BFF8F 4F               94     ; LD C, A
0BFF90 FADEC0           95     ; LD A, ($C0DE)
0BFF93 91               96     ; SUB C
0BFF94 4F               97     ; LD C, A
0BFF95 78               98     ; LD A, B
0BFF96 90               99     ; SUB B
0BFF97 47               100    ; LD B, A
0BFF98 0E21             101    ; LD C, 0x21
                        102    ; The same steps now repeated for X
                        103    ; First we check if the shadow value for X is set, set them to 0x10, the starting health.
0BFF9A FAFEDF           104    ; LD A, ($DFFE)
0BFF9D FE00             105    ; CP 0x00
0BFF9F 2005             106    ; JR NZ +#5
0BFFA1 3E10             107    ; LD A, 0x10
0BFFA3 EAFEDF           108    ; LD ($DFFE), A
0BFFA6 FAD5C0           109    ; LD A, ($C0D5)
0BFFA9 B9               110    ; CP C
0BFFAA 300C             111    ; JR NC +#12
0BFFAC 4F               112    ; LD C, A
0BFFAD FAFEDF           113    ; LD A, ($DFFE)
0BFFB0 B9               114    ; CP C
0BFFB1 300F             115    ; JR NC +#15
0BFFB3 FAD5C0           116    ; LD A, ($C0D5)
0BFFB6 180A             117    ; JR +#10
0BFFB8 4F               118    ; LD C, A
0BFFB9 FAD9C0           119    ; LD A, ($C0D9)
0BFFBC 91               120    ; SUB C
0BFFBD 4F               121    ; LD C, A
0BFFBE FAD5C0           122    ; LD A, ($C0D5)
0BFFC1 91               123    ; SUB C
0BFFC2 C9               124    ; RET
